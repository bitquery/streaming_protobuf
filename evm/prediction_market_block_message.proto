syntax = "proto3";
package evm_messages;

import "evm/block_message.proto";
import "evm/token_block_message.proto";
import "evm/parsed_abi_block_message.proto";

message PredictionMarketBlockMessage {
  Chain Chain = 1;
  BlockHeader Header = 2;
  optional BlockHeader L1Header = 3;

  repeated PredictionManagementEvent ManagementEvents = 4;
  repeated PredictionEmitEvent EmitEvents = 5;
  repeated PredictionEmitEvent TradeEvents = 6;
}

message PredictionMarketplaceInfo {
  bytes SmartContract = 1;      // marketplace contract address, UMA Adapter for polymarket: 0x65070BE91477460D8A7AeEb94ef92fe056C2f2A7

  string ProtocolName = 2;      // "Polymarket", "predict.fun"
  string ProtocolFamily = 3;    // "Gnosis_CTF"
  string ProtocolVersion = 4;  // ???
}

// https://gamma-api.polymarket.com/events?order=id&ascending=false&closed=false&limit=10&offset=0
// 1 event owns multiple questions, 1 questions owns usually 1 condition,
// 1 condition owns usually 1 market and multiple outcome tokens
message PredictionManagementEvent {
  bytes SmartContract = 1;  // smart contract that emitted the event, CTF Exchange for polymarket: 0xC5d563A36AE78145C45a50134d48A1215220f80a, 0x4bFb41d5B3570DeFd03C39a9A4D8dE6Bd8B8982E

  TransactionHeader TransactionHeader = 2;
  Signature TransactionSignature = 3;

  ParsedAbiCallHeader CallHeader = 4;
  ParsedAbiLogHeader LogHeader = 5;

  optional bytes EventId = 6; // ! possible confusion what eventId is for ! ; can be services without eventId
  string EventType = 7;	// CREATED, RESOLVED

  PredictionMarketplaceInfo Marketplace = 8;
  QuestionInfo Question = 9;

  ConditionInfo Condition = 10; // new condition for CREATED event || resolved condition for RESOLVED event
  optional OutcomeInfo Outcome = 11;    // winner for RESOLVED event [ one of condition.outcomes ]

  optional MarketInfo Market = 12;  // can be created after condition creation
  optional TokenInfo CollateralToken = 13; // USDC, USDT etc
}

message PredictionEmitEvent {
  bytes SmartContract = 1;

  TransactionHeader TransactionHeader = 2;
  Signature TransactionSignature = 3;

  uint64 CallIndex = 4;
  uint64 LogIndex = 5;

  optional bytes EventId = 6; // ! possible confusion what eventId is for !

  string EventType = 7;	// SPLIT, MERGE
  PredictionMarketplaceInfo Marketplace = 8;

  bytes QuestionId = 9;  // ? condition contains questionId

  bytes ConditionId = 10;
  repeated Partition Partitions = 11; // [[YES], [NO]]; possible [ [A,B], [C] ] /// merged or split outcome token indexes from condition

  MarketInfo Market = 12;
  TokenInfo CollateralToken = 13; // USDC, USDT etc

  bytes Amount = 14; // Collateral amount for SPLIT || Outcome amount of each outcome token for MERGE

  bytes Holder = 15; // Address of the user performing the action
}

message PredictionTradeEvent {
  bytes SmartContract = 1;

  TransactionHeader TransactionHeader = 2;
  Signature TransactionSignature = 3;

  uint64 CallIndex = 4;
  uint64 LogIndex = 5;

  bytes EventId = 6; // ! possible confusion what eventId is for !

  string EventType = 7;	// SPLIT, MERGE
  PredictionMarketplaceInfo Marketplace = 8;

  bytes QuestionId = 9;  // ? condition contains questionId

  bytes ConditionId = 10;
  OutcomeInfo Outcome = 11;
  bytes Amount = 12; // Outcome token amount traded
  bytes Maker = 13;

  MarketInfo Market = 14;
  TokenInfo CollateralToken = 15; // USDC, USDT etc
  bytes AmountPaid = 16; // Collateral amount paid by taker
  bytes Taker = 17;
}

message Partition {
  repeated OutcomeInfo outcome = 1;
}

message QuestionInfo {
  bytes Id = 1;    // question id, "0x78784dce991b76362f0409fc26e2a16aa0e520da3d47d4389bc55580850ff4d6" for polymarket
  bytes Data = 2; // string or HEX bytes ??
  string URI = 3;

  bytes Creator = 4;             // Address of question creator
  uint64 CreatedAt = 5;
  //uint64 UpdatedAt = 6;
  uint64 ResolutionTime = 7;     // Expected resolution timestamp
  uint64 Timeout = 8;            // Timeout for resolution

  string ResolutionSource = 17; // "https://data.chain.link/streams/eth-usd",
  string Image = 18; // https://polymarket-upload.s3.us-east-2.amazonaws.com/ETH+fullsize.jpg
}

message ConditionInfo {
  bytes Id = 1;           // condition id, "0x03a8a2d4ca694f0cfe9b700ed745a41694dfcfa40110ef68d08bf0d077f98acb" for polymarket
  bytes QuestionId = 2;

  bytes Creator = 3;  // Address that created the condition

  repeated OutcomeInfo Outcomes = 4;
}

// https://gamma-api.polymarket.com/markets?active=true&order=id&ascending=false&closed=false&limit=3&offset=1
message MarketInfo {
  bytes Id = 1;         // 568668 for polymarket
  reserved 3;           // possible market smartContract address

  bytes Creator = 4; // Address that created the market
  bytes Resolver = 5;
  bytes Oracle = 6;

  repeated TokenInfo CollateralTokens = 11; // USDC, USDT; usually one, but can be multiple
}

message OutcomeInfo {
  optional bytes Id = 1;  // ERC1155 token ID for outcome token or other id: 30047082238364305580334875801842609424049121375805509630177240923852213311546
  optional bytes SmartContract = 2;
  uint32 Index = 3;       // index in ConditionInfo (0, 1...)
  string Label = 4;       // for outcome: Yes, No, etc
}
