syntax = "proto3";
package evm_messages;

import "evm/block_message.proto";
import "evm/token_block_message.proto";
import "evm/parsed_abi_block_message.proto";

message PredictionMarketBlockMessage {
  Chain Chain = 1;
  BlockHeader Header = 2;
  optional BlockHeader L1Header = 3;

  repeated PredictionManagementEvent ManagementEvents = 4;
  repeated PredictionEmitEvent EmitEvents = 5;
  repeated PredictionEmitEvent TradeEvents = 6;
}

message PredictionMarketplaceInfo {
  bytes SmartContract = 1;      // marketplace contract address, UMA Adapter for polymarket: 0x65070BE91477460D8A7AeEb94ef92fe056C2f2A7

  string ProtocolName = 2;      // "Polymarket", "predict.fun"
  string ProtocolFamily = 3;    // "Gnosis_CTF"
  string ProtocolVersion = 4;  // ???
}

// https://gamma-api.polymarket.com/events?order=id&ascending=false&closed=false&limit=10&offset=0
// 1 event owns multiple questions, 1 questions owns usually 1 condition,
// 1 condition owns usually 1 market and multiple outcome tokens
message PredictionManagementEvent {
  TransactionHeader TransactionHeader = 1;
  Signature TransactionSignature = 2;

  PredictionEvent Event = 3;
  PredictionInfo Prediction = 4;
}

message PredictionEmitEvent {

  TransactionHeader TransactionHeader = 1;
  Signature TransactionSignature = 2;
  PredictionEvent Event = 3;
  PredictionInfo Prediction = 4;

  repeated Partition Partitions = 5; // [[YES], [NO]]; possible [ [A,B], [C] ] /// merged or split outcome token indexes from condition
  DealSide Holder = 6; // holder of collateral
}

message Partition {
  repeated int32 OutcomeIndexes = 1;
}

message DealSide {
  bytes Address = 1;
  bytes Amount = 2;
  TokenInfo Currency = 3;
}

message PredictionTradeEvent {
  TransactionHeader TransactionHeader = 1;
  Signature TransactionSignature = 2;

  PredictionEvent Event = 3;
  PredictionInfo Prediction = 4;

  DealSide Buyer = 5;
  DealSide Seller = 6;

}

message PredictionInfo {
  PredictionMarketplaceInfo Marketplace = 1;
  optional MarketInfo Market = 2;
  QuestionInfo Question = 3;
  ConditionInfo Condition = 4;
  optional OutcomeInfo Outcome = 5;
  optional bytes  EventId = 6;

  optional TokenInfo OutcomeToken = 7; // outcome token for CREATED event
  optional TokenInfo CollateralToken = 8; // USDC, USDT etc
}

message PredictionEvent {
  bytes  SmartContract = 1;
  uint64 CallIndex = 2;
  uint64 LogIndex = 3;
  string Type = 4;
}

message QuestionInfo {
  bytes Id = 1;    // question id, "0x78784dce991b76362f0409fc26e2a16aa0e520da3d47d4389bc55580850ff4d6" for polymarket
  bytes Data = 2; // string or HEX bytes ??
  string URI = 3;

  bytes Creator = 4;             // Address of question creator
  uint64 CreatedAt = 5;
  uint64 ResolutionTime = 6;     // Expected resolution timestamp
  uint64 Timeout = 7;            // Timeout for resolution

  string ResolutionSource = 8; // "https://data.chain.link/streams/eth-usd",
  string Image = 9; // https://polymarket-upload.s3.us-east-2.amazonaws.com/ETH+fullsize.jpg
}

message ConditionInfo {
  bytes Id = 1;           // condition id, "0x03a8a2d4ca694f0cfe9b700ed745a41694dfcfa40110ef68d08bf0d077f98acb" for polymarket
  bytes QuestionId = 2;
  bytes Creator = 3;  // Address that created the condition
  repeated OutcomeInfo Outcomes = 4;
}

// https://gamma-api.polymarket.com/markets?active=true&order=id&ascending=false&closed=false&limit=3&offset=1
message MarketInfo {
  bytes Id = 1;         // 568668 for polymarket
  bytes Creator = 2; // Address that created the market
  bytes Resolver = 3;
  bytes Oracle = 4;
}

message OutcomeInfo {
  optional bytes Id = 1;  // ERC1155 token ID for outcome token or other id: 30047082238364305580334875801842609424049121375805509630177240923852213311546
  uint32 Index = 2;       // index in ConditionInfo (0, 1...)
  string Label = 3;       // for outcome: Yes, No, etc
}
